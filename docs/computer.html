<!DOCTYPE html>

<html>
<head>
  <title>computer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">


              <a class="source" href="app.html">
                app.js
              </a>


              <a class="source" href="computer.html">
                computer.js
              </a>


              <a class="source" href="game.html">
                game.js
              </a>


              <a class="source" href="grid.html">
                grid.js (model)
              </a>


              <a class="source" href="player.html">
                player.js
              </a>


              <a class="source" href="grid_view.html">
                grid.js (view)
              </a>


              <a class="source" href="status.html">
                status.js
              </a>

          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>computer.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>define(
    [<span class="string">"underscore"</span>, <span class="string">"models/player"</span>],
    <span class="function"><span class="keyword">function</span><span class="params">( _, Player )</span> {</span>

        <span class="keyword">var</span> Computer = Player.extend({
            initialize: <span class="function"><span class="keyword">function</span><span class="params">()</span> {</span>
                <span class="keyword">this</span>.on( <span class="string">"your_move"</span>, <span class="keyword">this</span>.make_move, <span class="keyword">this</span> );
            },
            make_move: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">var</span> self = <span class="keyword">this</span>;

                <span class="keyword">var</span> moves_by_priority = [];</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The first move is a special case.  If the opposing player
chose the center move, we choose a corner.  If the other
player chose a side or corner, we take the center.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> ( grid.get(<span class="string">"move_count"</span>) === <span class="number">1</span> ) {
                    <span class="keyword">if</span> ( grid.last_move_was_center() ) {
                        moves_by_priority = [
                            <span class="keyword">this</span>.empty_corner
                        ];
                    } <span class="keyword">else</span> {
                        moves_by_priority = [
                            <span class="keyword">this</span>.center
                        ];
                    }
                } <span class="keyword">else</span> {</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>After the first move, we go through a priority list of moves,
as enumerated here:</p>
<p> <a href="http://en.wikipedia.org/wiki/Tic-tac-toe#Strategy">http://en.wikipedia.org/wiki/Tic-tac-toe#Strategy</a></p>

            </div>

            <div class="content"><div class='highlight'><pre>                    moves_by_priority = [
                        <span class="keyword">this</span>.win,
                        <span class="keyword">this</span>.block_win,
                        <span class="keyword">this</span>.fork,
                        <span class="keyword">this</span>.block_fork,
                        <span class="keyword">this</span>.center,
                        <span class="keyword">this</span>.opposite_corner,
                        <span class="keyword">this</span>.empty_corner,
                        <span class="keyword">this</span>.empty_side
                    ];
                }</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Go through each move by priority, making the first
available move.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                moves_by_priority.some( <span class="function"><span class="keyword">function</span><span class="params">( potential_move )</span> {</span>
                    <span class="keyword">var</span> move = _.bind(potential_move, self, grid )();
                    <span class="keyword">if</span> ( move ) {
                        grid.place_symbol( move.x, move.y, self.get(<span class="string">"symbol"</span>) );
                        <span class="keyword">return</span> <span class="literal">true</span>;
                    }

                    <span class="keyword">return</span> <span class="literal">false</span>;
                });
            },
            win_for: <span class="function"><span class="keyword">function</span><span class="params">( grid, symbol )</span> {</span>
                <span class="keyword">var</span> winning_move = <span class="literal">null</span>;

                <span class="keyword">var</span> path_coordinates = grid.path_coordinates();</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>To find a winning move for a given symbol, we iterate over
each of the eight possible paths in a grid and check if there&#39;s
two of the symbol and one blank cell.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                grid.paths().forEach( <span class="function"><span class="keyword">function</span><span class="params">( path, index )</span> {</span>
                    <span class="keyword">if</span> ( _.isEqual( path, [symbol, symbol, <span class="literal">null</span>] ) ) {
                        winning_move = path_coordinates[index][<span class="number">2</span>];
                    } <span class="keyword">else</span> <span class="keyword">if</span> ( _.isEqual( path, [symbol, <span class="literal">null</span>, symbol] ) ) {
                        winning_move = path_coordinates[index][<span class="number">1</span>];
                    } <span class="keyword">else</span> <span class="keyword">if</span> ( _.isEqual( path, [<span class="literal">null</span>, symbol, symbol] ) ) {
                        winning_move = path_coordinates[index][<span class="number">0</span>];
                    }
                });

                <span class="keyword">return</span> winning_move;
            },
            fork_for: <span class="function"><span class="keyword">function</span><span class="params">( grid, symbol )</span> {</span></pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Fork moves are the most complicated.  A fork move is any move
that creates two possible winning <em>next</em> moves.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> path_coordinates = grid.path_coordinates();</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>To keep track of possible fork moves we&#39;ll use a nested mapping
object so we can keep coordinates unique.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="keyword">var</span> potential_moves = {};

                <span class="keyword">var</span> add_potential_move = <span class="function"><span class="keyword">function</span><span class="params">( move )</span> {</span>
                    <span class="keyword">if</span> ( potential_moves[move.x] === <span class="literal">undefined</span> ) {
                        potential_moves[move.x] = {};
                    }
                    <span class="keyword">if</span> ( potential_moves[move.x][move.y] === <span class="literal">undefined</span> ) {
                        potential_moves[move.x][move.y] = <span class="number">0</span>;
                    }

                    potential_moves[move.x][move.y] += <span class="number">1</span>;
                };</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>To find <em>potential</em> fork moves we iterate over all the paths and
add any move that would create a win move on the next go-around</p>

            </div>

            <div class="content"><div class='highlight'><pre>                grid.paths().forEach( <span class="function"><span class="keyword">function</span><span class="params">( path, index )</span> {</span>
                    <span class="keyword">if</span> ( _.isEqual( path, [symbol, <span class="literal">null</span>, <span class="literal">null</span>] ) ) {
                        add_potential_move( path_coordinates[index][<span class="number">1</span>] );
                        add_potential_move( path_coordinates[index][<span class="number">2</span>] );
                    } <span class="keyword">else</span> <span class="keyword">if</span> ( _.isEqual( path, [<span class="literal">null</span>, symbol, <span class="literal">null</span>] ) ) {
                        add_potential_move( path_coordinates[index][<span class="number">0</span>] );
                        add_potential_move( path_coordinates[index][<span class="number">2</span>] );
                    } <span class="keyword">else</span> <span class="keyword">if</span> ( _.isEqual( path, [<span class="literal">null</span>, <span class="literal">null</span>, symbol] ) ) {
                        add_potential_move( path_coordinates[index][<span class="number">0</span>] );
                        add_potential_move( path_coordinates[index][<span class="number">1</span>] );
                    }
                });

                <span class="keyword">var</span> move = <span class="literal">null</span>;
                <span class="keyword">var</span> corner_moves = <span class="number">0</span>;
                <span class="keyword">var</span> side_moves = <span class="number">0</span>;</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>An actual fork move is any of the potential moves collected that
showed up <em>twice</em>, i.e. they provide two win moves.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="keyword">for</span> ( <span class="keyword">var</span> x <span class="keyword">in</span> potential_moves ) {
                    <span class="keyword">if</span> ( ! potential_moves.hasOwnProperty(x) ) {
                        <span class="keyword">continue</span>;
                    }
                    <span class="keyword">for</span> ( <span class="keyword">var</span> y <span class="keyword">in</span> potential_moves[x] ) {
                        <span class="keyword">if</span> ( ! potential_moves[x].hasOwnProperty(y) ) {
                            <span class="keyword">continue</span>;
                        }

                        <span class="keyword">if</span> ( potential_moves[x][y] &gt; <span class="number">1</span> ) {
                            move = {x: x, y: y};
                            <span class="keyword">if</span> ( grid.is_corner_move( move ) ) {
                                corner_moves += <span class="number">1</span>;
                            } <span class="keyword">else</span> <span class="keyword">if</span> ( grid.is_side_move( move ) ) {
                                side_moves += <span class="number">1</span>;
                            }
                        }
                    }
                }</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Special case: If the board ends up with us in the
center and the player with two opposite corners,
then we should pick a side to force them on the
defensive rather than blocking a fork in a corner
and opening up the other corner&#39;s fork.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                <span class="keyword">if</span> ( side_moves === <span class="number">0</span> &amp;&amp; corner_moves === <span class="number">2</span> ) {
                    move = <span class="keyword">this</span>.empty_side( grid );
                }

                <span class="keyword">return</span> move;
            },
            win: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">return</span> <span class="keyword">this</span>.win_for( grid, <span class="keyword">this</span>.get(<span class="string">"symbol"</span>) );
            },
            block_win: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">return</span> <span class="keyword">this</span>.win_for( grid, <span class="keyword">this</span>.opponent() );
            },
            fork: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">return</span> <span class="keyword">this</span>.fork_for( grid, <span class="keyword">this</span>.get(<span class="string">"symbol"</span>) );
            },
            block_fork: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">return</span> <span class="keyword">this</span>.fork_for( grid, <span class="keyword">this</span>.opponent() );
            },
            center: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">return</span> grid.values[<span class="number">1</span>][<span class="number">1</span>] === <span class="literal">null</span> ? {<span class="string">"x"</span>: <span class="number">1</span>, <span class="string">"y"</span>: <span class="number">1</span>} : <span class="literal">null</span>;
            },
            opposite_corner: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">var</span> move = <span class="literal">null</span>;
                <span class="keyword">var</span> opponent = <span class="keyword">this</span>.get(<span class="string">"symbol"</span>) === <span class="string">"x"</span> ? <span class="string">"o"</span> : <span class="string">"x"</span>;

                grid.corners().forEach( <span class="function"><span class="keyword">function</span><span class="params">( corner )</span> {</span>
                    <span class="keyword">if</span> ( grid.values[corner.y][corner.x] === opponent ) {
                        <span class="keyword">var</span> opposite = {
                            x: corner.x === <span class="number">0</span> ? <span class="number">2</span> : <span class="number">0</span>,
                            y: corner.y === <span class="number">0</span> ? <span class="number">2</span> : <span class="number">0</span>
                        };
                        <span class="keyword">if</span> ( ! grid.values[opposite.y][opposite.x] ) {
                            move = opposite;
                        }
                    }
                });

                <span class="keyword">return</span> move;
            },
            empty_corner: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">var</span> move = <span class="literal">null</span>;

                grid.corners().forEach( <span class="function"><span class="keyword">function</span><span class="params">( corner )</span> {</span>
                    <span class="keyword">if</span> ( ! grid.values[corner.y][corner.x] ) {
                        move = corner;
                    }
                });

                <span class="keyword">return</span> move;
            },
            empty_side: <span class="function"><span class="keyword">function</span><span class="params">( grid )</span> {</span>
                <span class="keyword">var</span> self = <span class="keyword">this</span>;

                <span class="keyword">var</span> move = <span class="literal">null</span>;</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Finding the proper empty side move is a <em>bit</em> more complicated
than just iterating over sides.  We want to choose a side move
that is adjacent to an opponent&#39;s corner if possible.  This way
we make the desired move but also possibly block potential forks.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                grid.sides().forEach( <span class="function"><span class="keyword">function</span><span class="params">( side )</span> {</span>
                    <span class="keyword">if</span> ( ! grid.values[side.y][side.x] ) {
                        <span class="keyword">if</span> (
                            (side.x === <span class="number">0</span> || side.x === <span class="number">2</span> ) &amp;&amp;
                            (
                                grid.values[<span class="number">0</span>][side.x] === self.opponent() ||
                                grid.values[<span class="number">2</span>][side.x] === self.opponent()
                            )
                        ) {
                            move = side;
                        } <span class="keyword">else</span> <span class="keyword">if</span> (
                            side.x === <span class="number">1</span> &amp;&amp;
                            (
                                grid.values[side.y][<span class="number">0</span>] === self.opponent() ||
                                grid.values[side.y][<span class="number">2</span>] === self.opponent()
                            )
                        ) {
                            move = side;
                        } <span class="keyword">else</span> <span class="keyword">if</span> ( move === <span class="literal">null</span> ) {
                            move = side;
                        }
                    }
                });

                <span class="keyword">return</span> move;
            }
        });

        <span class="keyword">return</span> Computer;
    }
);</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
